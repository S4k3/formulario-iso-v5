<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoría ISO 27001 para PYMES</title>
    <!-- Incluye Tailwind CSS para un estilo moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye la fuente Inter de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Azul marino suave */
        }
        .container {
            max-width: 900px;
        }
        .message-box {
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #d97706; /* Dorado oscuro */
            animation: spin 1s linear infinite;
        }
        .form-question input[type="radio"] {
            accent-color: #d97706; /* Dorado oscuro */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<!-- Pantalla de Carga -->
<div id="loading-screen" class="fixed inset-0 bg-gray-50 flex items-center justify-center flex-col p-4 text-center z-50">
    <div class="spinner mb-4"></div>
    <p class="text-xl font-semibold text-gray-700">Iniciando aplicación...</p>
    <p id="loading-message" class="text-gray-500 mt-2">Por favor, espera un momento.</p>
</div>

<!-- Pantalla de Error de Configuración (oculta por defecto) -->
<div id="error-screen" class="fixed inset-0 bg-red-50 flex items-center justify-center flex-col p-4 text-center z-50 hidden">
    <div class="p-8 bg-red-100 rounded-2xl border border-red-400">
        <h2 class="text-2xl font-bold text-red-700 mb-4">Error de Configuración</h2>
        <p class="text-lg text-red-600 mb-4">No se pudo inicializar la aplicación. La configuración de Firebase no es válida.</p>
        <p class="text-red-500 text-sm">Por favor, contacta con soporte técnico o verifica la configuración de tu entorno.</p>
    </div>
</div>

<!-- Pantalla de Login -->
<div id="login-screen" class="fixed inset-0 bg-gray-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm border border-gray-100">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Acceso al Sistema</h2>
        <form id="auth-form" class="space-y-6">
            <div>
                <label for="email" class="block text-gray-700 font-semibold mb-2">Correo Electrónico</label>
                <input type="email" id="email" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" required>
            </div>
            <div>
                <label for="password" class="block text-gray-700 font-semibold mb-2">Contraseña</label>
                <input type="password" id="password" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" required>
                <a href="#" id="forgot-password-link" class="text-sm text-amber-600 hover:text-amber-700 mt-2 block text-right font-medium transition duration-200">¿Olvidaste la contraseña?</a>
            </div>
            <div id="auth-error-message" class="text-sm text-red-600 hidden"></div>
            <button id="login-btn" type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0a4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
                </svg>
                <span>Iniciar Sesión</span>
            </button>
            <button id="register-btn" type="button" class="w-full bg-slate-200 hover:bg-slate-300 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 flex items-center justify-center space-x-2 mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M11.7 2.898a.75.75 0 0 1 .6 0C12.44 3.2 14.542 4.256 16.3 6.13a9.208 9.208 0 0 1 1.838 2.308c.306.634.53 1.32.7 2.036A6.994 6.994 0 0 0 20.25 12a.75.75 0 0 1 0 1.5 7.004 7.004 0 0 1-3.328 5.767 9.22 9.22 0 0 1-2.308 1.838c-.634.306-1.32.53-2.036.7a6.994 6.994 0 0 0-3.766 1.15.75.75 0 0 1-.6 0 7.004 7.004 0 0 0-3.766-1.15 9.22 9.22 0 0 1-2.308-1.838 7.004 7.004 0 0 1-3.328-5.767.75.75 0 0 1 0-1.5 6.994 6.994 0 0 0 1.838-2.308c.306-.634.53-1.32.7-2.036A7.004 7.004 0 0 1 12 4.5c.677 0 1.34.12 1.954.34zm4.187 6.375a.75.75 0 1 0-1.06-1.06L12 10.94l-2.277-2.277a.75.75 0 0 0-1.06 1.06L10.94 12l-2.277 2.277a.75.75 0 0 0 1.06 1.06L12 13.06l2.277 2.277a.75.75 0 0 0 1.06-1.06L13.06 12l2.277-2.277z" />
                </svg>
                <span>Registrarse</span>
            </button>
        </form>
    </div>
</div>

<!-- Contenedor Principal de la Aplicación -->
<div id="app-container" class="container mx-auto p-4 sm:p-8 pt-10 pb-10 hidden">

    <!-- Cabecera de la Aplicación -->
    <header class="bg-blue-950 rounded-3xl shadow-xl p-6 sm:p-8 mb-8 border border-blue-900 relative">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-2 text-center">Auditoría ISO 27001 para PYMES</h1>
        <p class="text-blue-200 text-center">Usa este formulario para evaluar la conformidad de los controles generales de TI (CGTI) en una PYME.</p>
        <p class="text-xs text-blue-400 mt-2 text-center">ID de Usuario: <span id="user-id" class="font-mono text-blue-200"></span></p>
        <!-- Botón de Cerrar Sesión -->
        <button id="logout-btn" class="absolute top-4 right-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 flex items-center justify-center space-x-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M7.5 3.75A1.5 1.5 0 0 0 6 5.25v13.5a1.5 1.5 0 0 0 1.5 1.5h6a1.5 1.5 0 0 0 1.5-1.5V15a.75.75 0 0 1 1.5 0v3.75a3 3 0 0 1-3 3h-6a3 3 0 0 1-3-3V5.25a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v2.25a.75.75 0 0 1-1.5 0V5.25a1.5 1.5 0 0 0-1.5-1.5h-6Zm10.72 4.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1 0 1.06l-3 3a.75.75 0 1 1-1.06-1.06l1.72-1.72H9a.75.75 0 0 1 0-1.5h10.94l-1.72-1.72a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
            <span>Cerrar Sesión</span>
        </button>
    </header>

    <!-- Caja de Mensajes -->
    <div id="message-box" class="message-box bg-amber-100 border border-amber-400 text-amber-700 px-4 py-3 rounded-2xl relative mb-6">
        <span class="block sm:inline" id="message-text"></span>
    </div>

    <!-- Sección del Formulario de Auditoría -->
    <div id="form-section" class="bg-blue-950 rounded-3xl shadow-xl p-6 sm:p-8 border border-blue-900">
        <h2 class="text-2xl font-bold text-white mb-6">Preguntas de la Auditoría</h2>
        
        <form id="audit-form" class="space-y-8">
            <!-- Pregunta 1 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q1" class="block text-gray-200 text-lg mb-2">1. ¿Existe una política de seguridad de la información documentada y comunicada a todos los empleados?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q1-yes" name="q1" value="Sí" required>
                    <label for="q1-yes">Sí</label>
                    <input type="radio" id="q1-no" name="q1" value="No">
                    <label for="q1-no">No</label>
                    <input type="radio" id="q1-partial" name="q1" value="Parcialmente">
                    <label for="q1-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 2 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q2" class="block text-gray-200 text-lg mb-2">2. ¿Se realizan evaluaciones de riesgos de seguridad de la información de manera regular?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q2-yes" name="q2" value="Sí" required>
                    <label for="q2-yes">Sí</label>
                    <input type="radio" id="q2-no" name="q2" value="No">
                    <label for="q2-no">No</label>
                    <input type="radio" id="q2-partial" name="q2" value="Parcialmente">
                    <label for="q2-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 3 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q3" class="block text-gray-200 text-lg mb-2">3. ¿Existe un plan de gestión de incidentes de seguridad de la información documentado y probado?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q3-yes" name="q3" value="Sí" required>
                    <label for="q3-yes">Sí</label>
                    <input type="radio" id="q3-no" name="q3" value="No">
                    <label for="q3-no">No</label>
                    <input type="radio" id="q3-partial" name="q3" value="Parcialmente">
                    <label for="q3-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 4 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q4" class="block text-gray-200 text-lg mb-2">4. ¿Se establecen y revisan periódicamente los objetivos de seguridad de la información?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q4-yes" name="q4" value="Sí" required>
                    <label for="q4-yes">Sí</label>
                    <input type="radio" id="q4-no" name="q4" value="No">
                    <label for="q4-no">No</label>
                    <input type="radio" id="q4-partial" name="q4" value="Parcialmente">
                    <label for="q4-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 5 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q5" class="block text-gray-200 text-lg mb-2">5. ¿Se aplican controles para la protección contra malware?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q5-yes" name="q5" value="Sí" required>
                    <label for="q5-yes">Sí</label>
                    <input type="radio" id="q5-no" name="q5" value="No">
                    <label for="q5-no">No</label>
                    <input type="radio" id="q5-partial" name="q5" value="Parcialmente">
                    <label for="q5-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 6 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q6" class="block text-gray-200 text-lg mb-2">6. ¿Existe una gestión de parches de seguridad para los sistemas operativos y aplicaciones?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q6-yes" name="q6" value="Sí" required>
                    <label for="q6-yes">Sí</label>
                    <input type="radio" id="q6-no" name="q6" value="No">
                    <label for="q6-no">No</label>
                    <input type="radio" id="q6-partial" name="q6" value="Parcialmente">
                    <label for="q6-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 7 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q7" class="block text-gray-200 text-lg mb-2">7. ¿Se realizan copias de seguridad de la información crítica de manera periódica?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q7-yes" name="q7" value="Sí" required>
                    <label for="q7-yes">Sí</label>
                    <input type="radio" id="q7-no" name="q7" value="No">
                    <label for="q7-no">No</label>
                    <input type="radio" id="q7-partial" name="q7" value="Parcialmente">
                    <label for="q7-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 8 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q8" class="block text-gray-200 text-lg mb-2">8. ¿Se prueba la restauración de las copias de seguridad?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q8-yes" name="q8" value="Sí" required>
                    <label for="q8-yes">Sí</label>
                    <input type="radio" id="q8-no" name="q8" value="No">
                    <label for="q8-no">No</label>
                    <input type="radio" id="q8-partial" name="q8" value="Parcialmente">
                    <label for="q8-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 9 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q9" class="block text-gray-200 text-lg mb-2">9. ¿Se establecen controles de acceso basados en el principio del mínimo privilegio?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q9-yes" name="q9" value="Sí" required>
                    <label for="q9-yes">Sí</label>
                    <input type="radio" id="q9-no" name="q9" value="No">
                    <label for="q9-no">No</label>
                    <input type="radio" id="q9-partial" name="q9" value="Parcialmente">
                    <label for="q9-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 10 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q10" class="block text-gray-200 text-lg mb-2">10. ¿Se implementa la autenticación de dos factores (2FA) para el acceso a sistemas críticos?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q10-yes" name="q10" value="Sí" required>
                    <label for="q10-yes">Sí</label>
                    <input type="radio" id="q10-no" name="q10" value="No">
                    <label for="q10-no">No</label>
                    <input type="radio" id="q10-partial" name="q10" value="Parcialmente">
                    <label for="q10-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 11 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q11" class="block text-gray-200 text-lg mb-2">11. ¿Se realiza una formación en concientización de seguridad de la información para los empleados?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q11-yes" name="q11" value="Sí" required>
                    <label for="q11-yes">Sí</label>
                    <input type="radio" id="q11-no" name="q11" value="No">
                    <label for="q11-no">No</label>
                    <input type="radio" id="q11-partial" name="q11" value="Parcialmente">
                    <label for="q11-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 12 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q12" class="block text-gray-200 text-lg mb-2">12. ¿Existe un inventario de activos de información?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q12-yes" name="q12" value="Sí" required>
                    <label for="q12-yes">Sí</label>
                    <input type="radio" id="q12-no" name="q12" value="No">
                    <label for="q12-no">No</label>
                    <input type="radio" id="q12-partial" name="q12" value="Parcialmente">
                    <label for="q12-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 13 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q13" class="block text-gray-200 text-lg mb-2">13. ¿Se clasifican los activos de información según su sensibilidad?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q13-yes" name="q13" value="Sí" required>
                    <label for="q13-yes">Sí</label>
                    <input type="radio" id="q13-no" name="q13" value="No">
                    <label for="q13-no">No</label>
                    <input type="radio" id="q13-partial" name="q13" value="Parcialmente">
                    <label for="q13-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 14 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q14" class="block text-gray-200 text-lg mb-2">14. ¿Se aplican controles físicos para proteger los activos de información, como servidores y equipos?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q14-yes" name="q14" value="Sí" required>
                    <label for="q14-yes">Sí</label>
                    <input type="radio" id="q14-no" name="q14" value="No">
                    <label for="q14-no">No</label>
                    <input type="radio" id="q14-partial" name="q14" value="Parcialmente">
                    <label for="q14-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 15 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q15" class="block text-gray-200 text-lg mb-2">15. ¿Existe una política de uso aceptable de activos y dispositivos móviles?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q15-yes" name="q15" value="Sí" required>
                    <label for="q15-yes">Sí</label>
                    <input type="radio" id="q15-no" name="q15" value="No">
                    <label for="q15-no">No</label>
                    <input type="radio" id="q15-partial" name="q15" value="Parcialmente">
                    <label for="q15-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 16 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q16" class="block text-gray-200 text-lg mb-2">16. ¿Se realizan pruebas de penetración o análisis de vulnerabilidades de manera periódica?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q16-yes" name="q16" value="Sí" required>
                    <label for="q16-yes">Sí</label>
                    <input type="radio" id="q16-no" name="q16" value="No">
                    <label for="q16-no">No</label>
                    <input type="radio" id="q16-partial" name="q16" value="Parcialmente">
                    <label for="q16-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 17 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q17" class="block text-gray-200 text-lg mb-2">17. ¿Existe un proceso para la gestión de acceso de usuarios y su baja?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q17-yes" name="q17" value="Sí" required>
                    <label for="q17-yes">Sí</label>
                    <input type="radio" id="q17-no" name="q17" value="No">
                    <label for="q17-no">No</label>
                    <input type="radio" id="q17-partial" name="q17" value="Parcialmente">
                    <label for="q17-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 18 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q18" class="block text-gray-200 text-lg mb-2">18. ¿Se cifran los datos sensibles, tanto en tránsito como en reposo?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q18-yes" name="q18" value="Sí" required>
                    <label for="q18-yes">Sí</label>
                    <input type="radio" id="q18-no" name="q18" value="No">
                    <label for="q18-no">No</label>
                    <input type="radio" id="q18-partial" name="q18" value="Parcialmente">
                    <label for="q18-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 19 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q19" class="block text-gray-200 text-lg mb-2">19. ¿Se realizan monitoreos y auditorías de los registros de actividad del sistema?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q19-yes" name="q19" value="Sí" required>
                    <label for="q19-yes">Sí</label>
                    <input type="radio" id="q19-no" name="q19" value="No">
                    <label for="q19-no">No</label>
                    <input type="radio" id="q19-partial" name="q19" value="Parcialmente">
                    <label for="q19-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 20 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q20" class="block text-gray-200 text-lg mb-2">20. ¿Existe una política de contratación que incluya la revisión de antecedentes de los empleados?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q20-yes" name="q20" value="Sí" required>
                    <label for="q20-yes">Sí</label>
                    <input type="radio" id="q20-no" name="q20" value="No">
                    <label for="q20-no">No</label>
                    <input type="radio" id="q20-partial" name="q20" value="Parcialmente">
                    <label for="q20-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 21 (Cuantitativa) -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q21" class="block text-gray-200 text-lg mb-2">21. ¿Con qué frecuencia (en días) se realizan las copias de seguridad de la información crítica?</label>
                <input type="number" id="q21" name="q21" class="w-full p-3 rounded-xl border border-blue-900 bg-slate-800 text-gray-200 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" min="1" required>
            </div>

            <!-- Pregunta 22 (Cuantitativa) -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q22" class="block text-gray-200 text-lg mb-2">22. ¿Cuántos incidentes de seguridad se registraron en el último trimestre?</label>
                <input type="number" id="q22" name="q22" class="w-full p-3 rounded-xl border border-blue-900 bg-slate-800 text-gray-200 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" min="0" required>
            </div>

            <!-- Pregunta 23 (Cuantitativa) -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q23" class="block text-gray-200 text-lg mb-2">23. ¿Cuál es el porcentaje de empleados que han recibido formación sobre seguridad en el último año?</label>
                <input type="number" id="q23" name="q23" class="w-full p-3 rounded-xl border border-blue-900 bg-slate-800 text-gray-200 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" min="0" max="100" required>
            </div>

            <!-- Pregunta 24 (Cuantitativa) -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q24" class="block text-gray-200 text-lg mb-2">24. ¿Cuántos años de antigüedad tiene la política de seguridad de la información actual?</label>
                <input type="number" id="q24" name="q24" class="w-full p-3 rounded-xl border border-blue-900 bg-slate-800 text-gray-200 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" min="0" required>
            </div>

            <!-- Pregunta 25 (Cuantitativa) -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q25" class="block text-gray-200 text-lg mb-2">25. ¿Con qué frecuencia (en meses) se realizan pruebas de vulnerabilidad en la red?</label>
                <input type="number" id="q25" name="q25" class="w-full p-3 rounded-xl border border-blue-900 bg-slate-800 text-gray-200 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" min="1" required>
            </div>

            <!-- Pregunta 26 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q26" class="block text-gray-200 text-lg mb-2">26. ¿Se realizan auditorías internas de seguridad de la información de forma anual?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q26-yes" name="q26" value="Sí" required>
                    <label for="q26-yes">Sí</label>
                    <input type="radio" id="q26-no" name="q26" value="No">
                    <label for="q26-no">No</label>
                    <input type="radio" id="q26-partial" name="q26" value="Parcialmente">
                    <label for="q26-partial">Parcialmente</label>
                </div>
            </div>
            
            <!-- Pregunta 27 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q27" class="block text-gray-200 text-lg mb-2">27. ¿Existe un plan de continuidad del negocio y recuperación ante desastres?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q27-yes" name="q27" value="Sí" required>
                    <label for="q27-yes">Sí</label>
                    <input type="radio" id="q27-no" name="q27" value="No">
                    <label for="q27-no">No</label>
                    <input type="radio" id="q27-partial" name="q27" value="Parcialmente">
                    <label for="q27-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 28 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q28" class="block text-gray-200 text-lg mb-2">28. ¿Se cifran las comunicaciones sensibles por correo electrónico?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q28-yes" name="q28" value="Sí" required>
                    <label for="q28-yes">Sí</label>
                    <input type="radio" id="q28-no" name="q28" value="No">
                    <label for="q28-no">No</label>
                    <input type="radio" id="q28-partial" name="q28" value="Parcialmente">
                    <label for="q28-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 29 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q29" class="block text-gray-200 text-lg mb-2">29. ¿Se realizan revisiones periódicas de los permisos de acceso de los empleados?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q29-yes" name="q29" value="Sí" required>
                    <label for="q29-yes">Sí</label>
                    <input type="radio" id="q29-no" name="q29" value="No">
                    <label for="q29-no">No</label>
                    <input type="radio" id="q29-partial" name="q29" value="Parcialmente">
                    <label for="q29-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Pregunta 30 -->
            <div class="form-question p-4 bg-slate-800 rounded-lg border border-blue-900">
                <label for="q30" class="block text-gray-200 text-lg mb-2">30. ¿La empresa tiene un proceso formal para la gestión de proveedores de servicios de TI?</label>
                <div class="flex items-center space-x-6 text-base text-gray-400">
                    <input type="radio" id="q30-yes" name="q30" value="Sí" required>
                    <label for="q30-yes">Sí</label>
                    <input type="radio" id="q30-no" name="q30" value="No">
                    <label for="q30-no">No</label>
                    <input type="radio" id="q30-partial" name="q30" value="Parcialmente">
                    <label for="q30-partial">Parcialmente</label>
                </div>
            </div>

            <!-- Área de texto para información adicional -->
            <div class="form-question mt-8">
                <label for="additional-info" class="block text-gray-200 text-lg mb-2">Información Adicional (opcional):</label>
                <textarea id="additional-info" rows="6" class="w-full p-4 rounded-xl border border-blue-900 bg-slate-800 text-gray-200 focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200" placeholder="Escribe aquí cualquier otra información relevante sobre la empresa o la auditoría."></textarea>
            </div>

            <!-- Botón de Envío -->
            <div class="text-center mt-8">
                <button type="submit" class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 flex items-center justify-center space-x-2 w-full sm:w-auto mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path d="M11.25 4.536A4.502 4.502 0 0 1 12 11.25a4.502 4.502 0 0 1-.75-6.714ZM12.75 12A4.502 4.502 0 0 1 12 4.5a4.502 4.502 0 0 1 .75 6.714ZM5.632 7.643a4.502 4.502 0 0 1 6.84-5.992M18.368 7.643a4.502 4.502 0 0 1-6.84-5.992M17.502 11.25a4.502 4.502 0 0 1-6.84 5.992M6.498 11.25a4.502 4.502 0 0 1 6.84 5.992M10.5 21.75a4.502 4.502 0 0 1-6.84-5.992M13.5 21.75a4.502 4.502 0 0 1 6.84-5.992M19.125 15.75a4.502 4.502 0 0 1-6.84-5.992M4.875 15.75a4.502 4.502 0 0 1 6.84-5.992" />
                    </svg>
                    <span>Obtener Recomendaciones de IA</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Sección de Historial de Reportes -->
    <div id="history-section" class="bg-blue-950 rounded-3xl shadow-xl p-6 sm:p-8 mt-8 border border-blue-900">
        <h2 class="text-2xl font-bold text-white mb-4">Reportes Anteriores</h2>
        <div id="reports-list" class="space-y-4">
            <!-- Los reportes se cargarán aquí -->
            <p class="text-gray-400 text-center">No se encontraron reportes anteriores.</p>
        </div>
    </div>
    
    <!-- Sección de Resultados de la IA -->
    <div id="results-section" class="bg-blue-950 rounded-3xl shadow-xl p-6 sm:p-8 mt-8 border border-blue-900 hidden">
        <h2 class="text-2xl font-bold text-white mb-6 text-center">Recomendaciones de IA</h2>
        <div id="recommendations-content" class="text-gray-300 leading-relaxed prose max-w-none">
            <!-- Las recomendaciones se cargarán aquí -->
        </div>
        <div class="text-center mt-8">
            <button id="back-to-form-btn" class="bg-slate-800 hover:bg-slate-700 text-gray-200 font-bold py-3 px-8 rounded-full transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 flex items-center justify-center space-x-2 mx-auto w-full sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 0 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                </svg>
                <span>Volver al Formulario</span>
            </button>
        </div>
    </div>

</div>

<!-- Scripts de Firebase y Lógica de la Aplicación -->
<script type="module">
    // Importa los módulos de Firebase necesarios
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Espera a que el DOM esté completamente cargado antes de ejecutar el código.
    document.addEventListener('DOMContentLoaded', () => {
        
        // **INSTRUCCIONES: REEMPLAZA ESTO CON LA CONFIGURACIÓN REAL DE TU PROYECTO DE FIREBASE**
        // Obtén esta información de la Consola de Firebase -> Configuración del Proyecto -> Tus apps
        const firebaseConfig = {
            apiKey: "AIzaSyC1JxhC09fyU8_dgLplE_pbJXUsfP39eZU",
            authDomain: "formulario-v1-52e2b.firebaseapp.com",
            projectId: "formulario-v1-52e2b",
            storageBucket: "formulario-v1-52e2b.firebasestorage.app",
            messagingSenderId: "489505492977",
            appId: "1:489505492977:web:aab34be89b584127c63e50",
            measurementId: "G-ZBR6VT84G1"
        };
        const appId = firebaseConfig.projectId;

        // Elementos del DOM
        const loadingScreen = document.getElementById('loading-screen');
        const errorScreen = document.getElementById('error-screen');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const userIdSpan = document.getElementById('user-id');
        const formSection = document.getElementById('form-section');
        const resultsSection = document.getElementById('results-section');
        const historySection = document.getElementById('history-section');
        const auditForm = document.getElementById('audit-form');
        const recommendationsContent = document.getElementById('recommendations-content');
        const backToFormBtn = document.getElementById('back-to-form-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const reportsList = document.getElementById('reports-list');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authErrorMessage = document.getElementById('auth-error-message');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        // Inicializa Firebase
        let app, db, auth;
        if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "TU_API_KEY") {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado con éxito.");
            } catch (error) {
                console.error("Error al inicializar Firebase:", error.message);
                loadingScreen.classList.add('hidden');
                errorScreen.classList.remove('hidden');
                return; // Detiene la ejecución si hay un error de inicialización
            }
        } else {
            console.error("Error: La configuración de Firebase no es válida o está vacía.");
            loadingScreen.classList.add('hidden');
            errorScreen.classList.remove('hidden');
            return; // Detiene la ejecución si la configuración no es válida
        }


        // Variable global para el ID de usuario
        let userId = null;

        // Función para mostrar mensajes de estado
        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.style.display = 'block';
            if (type === 'error') {
                messageBox.className = 'message-box bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-2xl relative mb-6';
            } else {
                messageBox.className = 'message-box bg-amber-100 border border-amber-400 text-amber-700 px-4 py-3 rounded-2xl relative mb-6';
            }
        }

        // Lógica de autenticación
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // El formulario es manejado por el evento de click en los botones
        });

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                authErrorMessage.textContent = 'Por favor, introduce un correo electrónico y una contraseña.';
                authErrorMessage.classList.remove('hidden');
                return;
            }

            authErrorMessage.classList.add('hidden');
            showMessage("Iniciando sesión...", 'info');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Usuario autenticado:', userCredential.user.uid);
            } catch (error) {
                console.error("Error al iniciar sesión:", error.message);
                authErrorMessage.textContent = `Error al iniciar sesión. ${error.message}`;
                authErrorMessage.classList.remove('hidden');
            }
        });

        registerBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                authErrorMessage.textContent = 'Por favor, introduce un correo electrónico y una contraseña.';
                authErrorMessage.classList.remove('hidden');
                return;
            }

            authErrorMessage.classList.add('hidden');
            showMessage("Registrando usuario...", 'info');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log('Usuario registrado:', userCredential.user.uid);
                showMessage("¡Registro exitoso! Ya puedes usar la aplicación.", 'info');
            } catch (error) {
                console.error("Error al registrar el usuario:", error.message);
                authErrorMessage.textContent = `Error al registrar: ${error.message}`;
                authErrorMessage.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('Sesión cerrada exitosamente.');
                showMessage("Sesión cerrada. Vuelve pronto.", 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage("Error al cerrar sesión. Por favor, inténtalo de nuevo.", 'error');
            }
        });
        
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            if (!email) {
                authErrorMessage.textContent = 'Por favor, introduce tu correo electrónico para restablecer la contraseña.';
                authErrorMessage.classList.remove('hidden');
                return;
            }
            
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage("Se ha enviado un correo de restablecimiento de contraseña. Por favor, revisa tu bandeja de entrada.", 'info');
                authErrorMessage.classList.add('hidden');
            } catch (error) {
                console.error("Error al enviar el correo de restablecimiento:", error);
                authErrorMessage.textContent = `Error al enviar el correo: ${error.message}`;
                authErrorMessage.classList.remove('hidden');
            }
        });


        // Escucha cambios de autenticación
        onAuthStateChanged(auth, (user) => {
            loadingScreen.classList.add('hidden');
            if (user) {
                userId = user.uid;
                userIdSpan.textContent = userId;
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                showMessage("¡Inicio de sesión exitoso! Bienvenido.", 'info'); // Mensaje de éxito
                // Ocultar el cuadro de mensaje después de 3 segundos
                setTimeout(() => {
                   messageBox.style.display = 'none';
                }, 3000);
                loadReports();
            } else {
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                userId = null;
                userIdSpan.textContent = 'No autenticado';
                // Opcional: limpiar la lista de reportes si no hay usuario
                reportsList.innerHTML = '<p class="text-gray-400 text-center">Inicia sesión para ver tus reportes.</p>';
            }
        });

        // Carga los reportes de auditoría desde Firestore
        function loadReports() {
            if (!userId) {
                console.error("Error: userId no está definido.");
                return;
            }

            const reportsRef = collection(db, `artifacts/${appId}/users/${userId}/reports`);
            
            onSnapshot(reportsRef, (snapshot) => {
                const reports = [];
                snapshot.forEach(doc => {
                    reports.push({ id: doc.id, ...doc.data() });
                });

                reports.sort((a, b) => {
                    const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return dateB - dateA;
                });

                renderReports(reports);
            }, (error) => {
                console.error("Error al cargar los reportes:", error);
                showMessage("No se pudieron cargar los reportes anteriores.", 'error');
            });
        }

        // Renderiza la lista de reportes en el DOM
        function renderReports(reports) {
            reportsList.innerHTML = '';
            if (reports.length === 0) {
                reportsList.innerHTML = '<p class="text-gray-400 text-center">No se encontraron reportes anteriores.</p>';
            } else {
                reports.forEach(report => {
                    const reportElement = document.createElement('div');
                    reportElement.className = 'bg-slate-800 p-4 rounded-xl border border-blue-900 cursor-pointer hover:bg-slate-700 transition duration-200';
                    const date = report.timestamp ? new Date(report.timestamp.seconds * 1000).toLocaleString() : 'Fecha desconocida';
                    reportElement.innerHTML = `
                        <h3 class="text-lg font-semibold text-white">Reporte de Auditoría</h3>
                        <p class="text-sm text-gray-400 mt-1">Fecha: ${date}</p>
                    `;
                    reportElement.addEventListener('click', () => {
                        displayReport(report);
                    });
                    reportsList.appendChild(reportElement);
                });
            }
        }
        
        // Muestra un reporte específico en la sección de resultados
        function displayReport(report) {
            recommendationsContent.innerHTML = report.recommendations;
            historySection.classList.add('hidden');
            formSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            showMessage(`Mostrando reporte del ${new Date(report.timestamp.seconds * 1000).toLocaleString()}`, 'info');
        }

        // Lógica para enviar el formulario y obtener las recomendaciones de IA
        auditForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            showMessage("Analizando las respuestas... Por favor, espera.");

            const formData = new FormData(auditForm);
            const answers = {};
            for (let [key, value] of formData.entries()) {
                answers[key] = value;
            }
            const additionalInfo = answers['additional-info'];
            delete answers['additional-info'];

            const prompt = `Actúa como un auditor de ciberseguridad experto en la norma ISO 27001, con un enfoque en pequeñas y medianas empresas (PYMES). Te han proporcionado las siguientes respuestas a una auditoría sobre Controles Generales de Tecnologías de la Información (CGTI). A partir de esta información, genera un informe detallado con recomendaciones claras y concisas.

            Responde en un formato amigable para el usuario, usando encabezados de Markdown para organizar tu informe. El informe debe incluir:
            
            1.  Un resumen del estado general de la ciberseguridad de la empresa, basado en los puntos fuertes y las áreas de mejora.
            2.  Un análisis detallado de cada pregunta que fue respondida con "No", "Parcialmente", o que tiene un valor cuantitativo que representa un riesgo (por ejemplo, un número bajo de formaciones o una frecuencia de backup alta), explicando por qué es un riesgo y sugiriendo acciones correctivas concretas y prácticas.
            3.  Recomendaciones finales para mejorar la postura de seguridad de la empresa.

            Asegúrate de que tus recomendaciones sean aplicables y realistas para una PYME, considerando sus limitaciones de recursos.

            Datos de la auditoría:
            - Respuestas: ${JSON.stringify(answers, null, 2)}
            - Información adicional proporcionada por el auditor: "${additionalInfo}"`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "Actúa como un experto en ciberseguridad, especializado en la norma ISO 27001 para PYMES. Usa un tono profesional y claro." }]
                    }
                };

                const apiKey = "AIzaSyDEZ2Cwqu2uYEynUw2FgCLi0Edu0D833Uo";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    recommendationsContent.innerHTML = text.replace(/\n/g, '<br>');
                    
                    const reportsRef = collection(db, `artifacts/${appId}/users/${userId}/reports`);
                    await addDoc(reportsRef, {
                        answers: answers,
                        additionalInfo: additionalInfo,
                        recommendations: text,
                        timestamp: serverTimestamp(),
                        userId: userId
                    });

                    formSection.classList.add('hidden');
                    historySection.classList.add('hidden');
                    resultsSection.classList.remove('hidden');
                    showMessage("Recomendaciones generadas y guardadas exitosamente.", 'info');
                } else {
                    throw new Error("No se pudo obtener una respuesta de la IA.");
                }

            } catch (error) {
                console.error("Error al generar las recomendaciones de IA:", error);
                showMessage(`Error al generar las recomendaciones. Inténtalo de nuevo. Detalle: ${error.message}`, 'error');
            }
        });

        backToFormBtn.addEventListener('click', () => {
            resultsSection.classList.add('hidden');
            historySection.classList.remove('hidden');
            formSection.classList.remove('hidden');
            auditForm.reset();
            showMessage("Formulario listo para una nueva auditoría.", 'info');
        });
    });
</script>

</body>
</html>

